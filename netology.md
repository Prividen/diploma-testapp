# Дипломный практикум в Yandex.Cloud (testapp)
В этом репозитории находятся файлы для развёртывания тестового приложения. Инфраструктурная часть проекта находится в 
другом репозитории.

### Докер-образ приложения
[Собираем](testapp/docker) его на основе `nginx:stable` и кладём в образ самую простенькую конфигурацию и заглушку индексной страницы. 

### Организации конфигурации: qbec
Поддерживается два окружения - `stage` и `prod`. Индексная страница подсовывается как ConfigMap, содержимое её меняется 
в зависимости от выбранного окружения, и ещё в неё попадает тэг используемого образа приложения и Git-тег/коммит деплоя.  
`qbec.yaml` формируется [плейбуком](testapp.yaml) динамически, в него записываются несекретные переменные. А секретные 
(ключ сервисного аккаунта для доступа к registry) - передаются как переменные окружения. 

### CI/CD
Согласно заданию:
- при любом коммите происходит сборка Докер-образа и отправка его в наш облачный registry.
- при создании Git-тега на образ Докера навешиваются дополнительно теги `:<имя-git-тега>` и `stable`, а приложение 
деплоится (в stage-окружение).

Кроме того:
- при каждом коммите собранный образ запускается и тестируется, чтоб правильную заглушку отдал, и происходит валидация 
конфигурации приложения.
- если prod-окружение было выбрано вручную (`USE_DEPLOY_ENV`=`prod`), или оно было унаследовано 
от инфраструктурного пайплайна при первоначальном развёртывании приложения, то вне зависимости от текущего HEAD 
будет выбран коммит с последним созданным Git-тегом.  
Чиста в целях реализации мер по обеспечению стабильности приложения в рамках prod-окружения. 
